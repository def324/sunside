# Development Notes

This document collects conventions, decisions, and notes that help maintain and extend Sunside.

## Node, npm, and tooling

- Use **Node 24.x LTS** for development (see `package.json` engines).
- Primary scripts:
  - `npm run dev`
  - `npm run build`
  - `npm run build:all` (regenerate data/assets + test + build)
  - `npm run preview`
  - `npm test -- --run` (single run; recommended for one-off checks / CI)
  - `npm test` (watch; blocks / keeps running)
  - `npm run prepare:airports`
  - `npm run prepare:map`
  - `npm run build:map-svg`

## Code organization

- Keep core logic UI-agnostic and testable in `src/core/`.
- Keep Svelte components focused on presentation/interaction in `src/ui/`.
- Add/update tests in `tests/` when changing `src/core/`.

## Day/night overlay notes

- The global day/night overlay is computed in `src/core/daynight.ts`.
- It uses the subsolar point and an analytic terminator sampled by longitude to produce stable SVG paths (avoids seam-related artifacts from polygon unwrapping).
- The global civil twilight band (sun altitude between `0°` and `-6°`) is built in the same longitude order and stays aligned with the terminator (avoids seam-related jitter during playback).
- Aircraft-local classification in `src/core/sun.ts` still uses `day | twilight | night`.

## Map notes

- The UI renders the base map from `public/map.svg` (generated from `src/data/map.json`).
- Antimeridian-crossing rings are split during preprocessing to avoid wraparound artifacts in `public/map.svg`.
- Polar “wrap” rings (odd number of dateline jumps) are capped to the nearest pole edge to preserve Antarctica-style geometry.
- Flight routes are also split at the map seam to avoid a long connecting line when a route wraps from `x≈1800` to `x≈0`.

## UI status

Current UI supports:

- Airport selection (typeahead with ranked, diacritic-insensitive matching) and local time inputs.
- Optional “Auto-estimate arrival time” based on route distance (rounded to 30 minutes).
- Great-circle route rendering.
- Timeline play/scrub controls that update aircraft position and sun/day-night state.
- Timeline header shows route, duration, and distance (defaults to km/mi by locale; click to cycle km/mi/nmi).
- Global day/night overlay + sun marker that updates with time.
- Pan/zoom on the map (wheel/pinch + drag + zoom buttons).
- The UI is split into coarse presentational panels under `src/ui/components/`, with global styles in `src/ui/app.css`.

Notes:

- Default route/time on load is `AMS → GRU` on today’s date (`11:00` departure, `19:00` arrival; local times). Auto-estimate is enabled, but the initial arrival time is not overridden until the user changes route/departure.
- A few UI preferences persist via local storage: auto-estimate toggle, distance unit selection, and playback pace.
- Distance defaults to km/mi based on browser locale; clicking the distance cycles km/mi/nmi.
- Responsive breakpoints: mobile ≤640px uses the compact inline-label flight setup; tablet widths stack map/timeline; wide screens (≥1250px) show map+timeline side-by-side and the flight setup expands to four columns.
- iOS Safari note: temporal inputs (`type="date"`, `type="time"`) can have stubborn intrinsic widths; the small-screen layout uses wrapping flex rows to prevent overflow.

## Demo media (README)

The README can embed an animated demo at `docs/images/demo.webp`.

This file is generated by the manual GitHub Actions workflow `Generate demo media` (`.github/workflows/demo.yml`). Run it after major UI changes that affect layout or animation.

Capture settings (current):

- Viewport: `1250×750` (desktop layout).
- URL: `https://def324.github.io/sunside/?autoplay=true&autoplaySpeed=4&autoplayDelayMs=6500`
- Playback: the in-app animation runs for `30s / 4 = 7.5s` at Fast pace.
- Capture: `80` frames captured every `100ms`, saved with `100ms` per frame.

Note: the upstream action waits ~5 seconds after page load before starting capture, and also supports `start_delay`. The demo URL uses `autoplayDelayMs` so the animation starts right after capture begins.

Autoplay query params:

- `autoplay=true` starts playback automatically.
- `autoplaySpeed=1|2|4` sets pace (invalid values are ignored).
- `autoplayDelayMs` delays the start (clamped to `0..10000`).

Share flight query params:

- `from=<code|id>` and `to=<code|id>` select airports (`IATA`, `ICAO`, `ident`, or numeric airport `id`).
- `depart=YYYY-MM-DDTHH:mm` is the local departure date/time at the departure airport.
- `arrive=YYYY-MM-DDTHH:mm` is the local arrival date/time at the arrival airport.
- Optional: `autoplay=true` and `autoplaySpeed=1|2|4` (share-only and not persisted).

Notes:

- Share links always start at `t=0` (they do not encode slider position).
- Auto-estimate is not encoded in the link; each user’s saved preference applies.
- Even if auto-estimate is enabled, the arrival time from the link is treated as authoritative until the user changes route/departure (same behavior as the default `AMS → GRU` configuration).

Potential next refactors:

- Move more state/logic out of `src/ui/App.svelte` into dedicated modules/stores as needed.
- Extract finer-grained UI components if/when the panels get too large.
